<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TYPEFAST</title>
<style>
:root{
  --bg:#0f0f0f;--text:#fff;--accent:#facc15;--accent2:#a78bfa;
  --warn:#f97316;--danger:#ef4444;--dim:#555;--surface:#1c1c1c;
  --correct:#22c55e;--key-bg:#2a2a2a;--key-text:#666
}
*{margin:0;padding:0;box-sizing:border-box}
body{min-height:100vh;background:var(--bg);color:var(--text);font-family:'Courier New',monospace;
  display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
.screen{width:100%;min-height:100vh;display:flex;flex-direction:column;
  align-items:center;justify-content:center;padding:1.5rem}
.hidden{display:none!important}
button{font-family:'Courier New',monospace;cursor:pointer}
.btn-main{background:var(--accent);color:#000;border:none;padding:.9rem 3rem;
  font-size:1.1rem;font-weight:900;letter-spacing:.12em;border-radius:4px;transition:transform .1s,opacity .1s}
.btn-main:hover{opacity:.9;transform:scale(1.03)}
.btn-sub{background:none;color:var(--dim);border:none;padding:.75rem 2rem;font-size:.9rem;margin-top:.3rem}

#logo{font-size:3.5rem;font-weight:900;letter-spacing:.15em;color:var(--accent);text-shadow:0 0 30px rgba(250,204,21,.3)}
#tagline{color:var(--dim);margin:.4rem 0 2.5rem;font-size:.9rem;letter-spacing:.08em}
#menu-hs{color:var(--accent);font-size:.9rem;margin-bottom:1.2rem;letter-spacing:.05em;min-height:1.2rem}
.menu-info{margin-top:2.5rem;color:var(--dim);font-size:.78rem;text-align:center;line-height:2;letter-spacing:.03em}

.hdr{position:absolute;top:1.6rem;left:0;right:0;display:flex;justify-content:space-between;
  align-items:center;padding:0 1.8rem;font-size:.82rem;color:var(--dim)}
.hv{color:var(--text);font-weight:bold;font-size:.95rem}
#hdr-streak-wrap{display:flex;align-items:center;gap:.3rem}
#fire-icons{letter-spacing:-.05em}

#timer-wrap{width:min(380px,82vw);height:5px;background:var(--surface);
  border-radius:3px;margin-bottom:3.5rem;position:relative;overflow:visible}
#timer-bar{height:100%;width:100%;border-radius:3px;transition:width 1s linear,background .4s}
#timer-wrap.pulse{animation:tpulse .45s ease infinite}

#combo-badge{position:absolute;top:5rem;left:50%;transform:translateX(-50%);
  font-size:.72rem;letter-spacing:.12em;padding:.25rem .8rem;border-radius:20px;
  font-weight:900;transition:opacity .3s;opacity:0;pointer-events:none}
#combo-badge.show{opacity:1}
#combo-badge.x2{background:var(--warn);color:#000}
#combo-badge.x3{background:var(--danger);color:#fff;animation:combopulse .55s ease infinite}

#word-area{min-height:7rem;display:flex;flex-direction:column;
  align-items:center;justify-content:center;margin-bottom:2rem;position:relative}
#word-letters{font-size:clamp(1.4rem,5vw,3.4rem);font-weight:900;letter-spacing:.18em;
  user-select:none;max-width:90vw;text-align:center;word-break:break-all;line-height:1.3;
  transition:opacity .3s,filter .3s}
#word-letters.hidden-word{opacity:0;filter:blur(8px)}
#word-letters.reveal{animation:wordReveal .35s ease forwards}

#announcing{font-size:.82rem;letter-spacing:.18em;color:var(--accent);
  margin-bottom:.6rem;opacity:0;transition:opacity .25s;display:flex;align-items:center;gap:.5rem}
#announcing.show{opacity:1}
.speak-bars{display:flex;align-items:flex-end;gap:3px;height:16px}
.speak-bar{width:3px;background:var(--accent);border-radius:2px;animation:barBounce .6s ease infinite}
.speak-bar:nth-child(1){animation-delay:0s;height:6px}
.speak-bar:nth-child(2){animation-delay:.15s;height:12px}
.speak-bar:nth-child(3){animation-delay:.3s;height:8px}
.speak-bar:nth-child(4){animation-delay:.1s;height:14px}
.speak-bar:nth-child(5){animation-delay:.25s;height:5px}

#wpm-flash{position:absolute;top:-2.8rem;left:50%;transform:translateX(-50%);
  font-size:1.6rem;font-weight:900;color:var(--accent);letter-spacing:.05em;
  pointer-events:none;opacity:0;white-space:nowrap}
#wpm-flash.pop{animation:wpmPop .9s ease-out forwards}

#game-input{background:none;border:none;border-bottom:2px solid #333;
  color:var(--text);font-size:1.5rem;font-family:'Courier New',monospace;
  text-align:center;width:min(360px,85vw);padding:.5rem;outline:none;
  letter-spacing:.12em;transition:border-color .2s,opacity .3s}
#game-input:focus{border-color:var(--accent)}
#game-input:disabled{opacity:.3}
.hint{margin-top:.8rem;color:var(--dim);font-size:.75rem;letter-spacing:.04em;transition:opacity .3s}
.hint.muted{opacity:0}

#live-wpm{position:absolute;bottom:1.5rem;left:50%;transform:translateX(-50%);
  font-size:.78rem;color:var(--dim);letter-spacing:.05em;white-space:nowrap}

#tick-el{font-size:3.2rem;display:none}

#elim-banner{position:fixed;inset:0;background:rgba(0,0,0,.78);backdrop-filter:blur(8px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:200;opacity:0;pointer-events:none;transition:opacity .3s}
#elim-banner.show{opacity:1;pointer-events:all}
#elim-word{font-size:.85rem;color:var(--dim);margin-bottom:.5rem;letter-spacing:.08em}
#elim-msg{font-size:2.2rem;font-weight:900;color:var(--danger);letter-spacing:.12em;margin-bottom:.3rem}
#elim-correct{font-size:1.1rem;color:var(--correct);margin-bottom:2rem;letter-spacing:.05em}

#keyboard{margin-top:1.8rem;display:flex;flex-direction:column;align-items:center;gap:5px}
.kb-row{display:flex;gap:5px}
.key{width:clamp(22px,3.2vw,34px);height:clamp(22px,3.2vw,34px);background:var(--key-bg);
  color:var(--key-text);border-radius:4px;display:flex;align-items:center;
  justify-content:center;font-size:clamp(.42rem,.7vw,.62rem);border:1px solid #2e2e2e;
  transition:background .1s,color .1s,transform .08s}
.key.ok{background:var(--correct)!important;color:#000!important;transform:scale(1.18)}
.key.err{background:var(--danger)!important;color:#fff!important}

#countdown{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:100}
#cdown-num{font-size:6rem;font-weight:900;color:var(--accent)}

.pt{position:fixed;width:7px;height:7px;border-radius:50%;pointer-events:none;
  z-index:150;animation:burst .65s ease-out forwards}
.score-pop{position:fixed;font-size:1.3rem;font-weight:900;pointer-events:none;
  z-index:300;animation:scorefloat .8s ease-out forwards}

.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin:1.4rem 0;width:min(340px,85vw)}
.stat-box{background:var(--surface);padding:1rem;text-align:center;border-radius:6px}
.stat-val{font-size:1.6rem;font-weight:900;color:var(--accent)}
.stat-lbl{font-size:.68rem;color:var(--dim);margin-top:.3rem;letter-spacing:.06em;text-transform:uppercase}

@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-9px)}40%{transform:translateX(9px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}}
@keyframes pop{0%{transform:scale(.4);opacity:0}60%{transform:scale(1.35)}100%{transform:scale(1);opacity:1}}
@keyframes burst{0%{transform:translate(0,0);opacity:1}100%{transform:translate(var(--dx),var(--dy));opacity:0}}
@keyframes cdown{0%{transform:scale(1.7);opacity:0}20%{transform:scale(1);opacity:1}80%{transform:scale(1);opacity:1}100%{transform:scale(.4);opacity:0}}
@keyframes tpulse{0%,100%{opacity:1}50%{opacity:.2}}
@keyframes combopulse{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.1)}}
@keyframes scorefloat{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-65px);opacity:0}}
@keyframes wpmPop{0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1.3)}60%{opacity:1;transform:translateX(-50%) translateY(-8px) scale(1)}100%{opacity:0;transform:translateX(-50%) translateY(-20px) scale(.9)}}
@keyframes wordReveal{0%{opacity:0;filter:blur(8px);transform:scale(.92)}100%{opacity:1;filter:blur(0);transform:scale(1)}}
@keyframes barBounce{0%,100%{transform:scaleY(.4)}50%{transform:scaleY(1)}}
@media(max-width:600px){#keyboard{display:none}}
</style>
</head>
<body>

<div id="countdown" class="hidden">
  <div id="cdown-num"></div>
  <div style="font-size:.95rem;color:var(--dim);margin-top:1rem;letter-spacing:.25em">GET READY</div>
</div>

<div id="elim-banner">
  <div id="elim-word"></div>
  <div id="elim-msg">âŒ ELIMINATED</div>
  <div id="elim-correct"></div>
</div>

<!-- MENU -->
<div id="screen-menu" class="screen">
  <div id="logo">TYPEFAST</div>
  <div id="tagline">think fast Â· type faster</div>
  <div id="menu-hs"></div>
  <button class="btn-main" onclick="runCountdown()">â–¶ PLAY</button>
  <div class="menu-info">
    auto-submits on correct Â· <kbd style="color:var(--text)">Enter</kbd> to submit manually<br>
    wrong answer = <span style="color:var(--danger)">eliminated</span> Â· 5+ streak = 2Ã— Â· 10+ = 3Ã—<br>
    announcer reads every word Â· every 10th word is a boss ğŸ’€
  </div>
</div>

<!-- GAME -->
<div id="screen-game" class="screen hidden">
  <div class="hdr">
    <div>score <span class="hv" id="hdr-score">0</span></div>
    <div id="hdr-wpm-strip" style="color:var(--accent);font-weight:900;font-size:.88rem">â€” WPM</div>
    <div id="hdr-streak-wrap">streak <span class="hv" id="hdr-streak">0</span><span id="fire-icons"></span></div>
  </div>

  <div id="combo-badge">2Ã— COMBO</div>
  <div id="timer-wrap"><div id="timer-bar"></div></div>

  <div id="word-area">
    <div id="wpm-flash"></div>
    <div id="boss-label" style="font-size:.65rem;letter-spacing:.2em;color:var(--danger);margin-bottom:.3rem;opacity:0;transition:opacity .3s">ğŸ’€ BOSS WORD</div>
    <div id="announcing">
      <div class="speak-bars">
        <div class="speak-bar"></div><div class="speak-bar"></div>
        <div class="speak-bar"></div><div class="speak-bar"></div>
        <div class="speak-bar"></div>
      </div>
      <span id="announcing-text">LISTENINGâ€¦</span>
    </div>
    <div id="word-letters" class="hidden-word"></div>
    <div id="tick-el">âœ…</div>
  </div>

  <input id="game-input" type="text" placeholder="type hereâ€¦"
         autocomplete="off" autocorrect="off" spellcheck="false"
         oninput="onInput()" onkeydown="onKey(event)" disabled/>
  <div class="hint muted" id="hint-text">auto-submits when correct Â· Enter to submit (wrong = eliminated)</div>
  <div id="keyboard"></div>
  <div id="live-wpm"></div>
</div>

<!-- GAME OVER -->
<div id="screen-over" class="screen hidden">
  <div style="font-size:1.4rem;color:var(--danger);margin-bottom:.4rem;letter-spacing:.12em;font-weight:900">ELIMINATED</div>
  <div style="font-size:.82rem;color:var(--dim);margin-bottom:.8rem" id="over-word-label"></div>
  <div style="font-size:4.5rem;font-weight:900;color:var(--accent)" id="over-score">0</div>
  <div style="color:var(--dim);margin-bottom:.4rem;font-size:.85rem">POINTS</div>
  <div id="over-hs" style="color:var(--accent);font-size:.88rem;min-height:1.3rem;margin-bottom:.8rem"></div>
  <div class="stat-grid">
    <div class="stat-box"><div class="stat-val" id="st-best-wpm">â€”</div><div class="stat-lbl">Best WPM</div></div>
    <div class="stat-box"><div class="stat-val" id="st-avg-wpm">â€”</div><div class="stat-lbl">Avg WPM</div></div>
    <div class="stat-box"><div class="stat-val" id="st-acc">â€”</div><div class="stat-lbl">Accuracy</div></div>
    <div class="stat-box"><div class="stat-val" id="st-streak">0</div><div class="stat-lbl">Best Streak</div></div>
  </div>
  <button class="btn-main" onclick="runCountdown()">PLAY AGAIN</button>
  <button class="btn-sub" onclick="showMenu()">menu</button>
</div>

<script>
// â”€â”€ WORD LISTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const W={
  easy:[
    "cat","dog","run","big","sun","hat","red","cup","leg","map",
    "box","pen","far","win","hot","old","new","ice","air","sky",
    "sea","job","fun","key","bag","arm","ear","eye","lip","rib",
    "ant","bat","cab","dam","eel","fan","gem","hen","ink","jar",
    "keg","log","mud","net","oak","paw","rat","sap","tin","web",
    "yak","zoo","arc","dew","fog","gut","hip","ivy","jot","kit",
    "lap","mob","nap","ore","pod","rug","sob","tan","urn","van",
    "wax","yew","zip","axe","bay","cog","den","elm","foe","gap"
  ],
  med:[
    "apple","brave","chess","drive","eagle","flame","grace","happy","image","joker",
    "kneel","lemon","magic","night","ocean","piano","queen","river","stone","tiger",
    "under","voice","water","youth","zebra","blaze","cloud","dance","earth","frost",
    "giant","handy","inlet","jewel","karma","latch","manor","nerve","orbit","plaid",
    "query","ridge","scone","trout","usher","venom","waltz","xenon","yacht","zonal",
    "abbey","brine","crisp","duchy","ember","flint","graft","heron","irony","joust",
    "knack","lyric","marsh","nymph","oxide","pluck","quirk","realm","shrub","taunt",
    "ulcer","vivid","wrist","xylem","yearn","zesty","brisk","cleft","dross","expel"
  ],
  hard:[
    "balloon","cabinet","diamond","elegant","fashion","granite","harmony","inspire","jumping","kitchen",
    "landing","morning","natural","opening","painted","quantum","rapidly","silence","theater","uniform",
    "vibrant","weather","younger","ancient","balance","captain","dolphin","emperor","factory","gesture",
    "highway","illness","jasmine","kinship","lantern","mineral","network","obvious","pilgrim","quarter",
    "reserve","station","texture","upriver","village","warrior","yellowed","zealous","abstain","bracket",
    "cobweb","discord","earnest","ferment","genuine","harmful","impeach","journey","kingdom","leisure",
    "mandate","nominal","outpost","pyramid","quintet","rampart","sinuous","upright","vagrant","eclipse"
  ],
  exp:[
    "accomplish","beautiful","celebrate","determine","elaborate","furniture","glamorous","highlight","important","journalist",
    "knowledge","landscape","narrative","obsession","recognize","structure","temporary","universal","vulnerable","wonderful",
    "extremely","breathing","certainly","chocolate","different","establish","fantastic","gorgeous","honorable","invisible",
    "justifiable","kilometer","luxurious","mythology","nourished","operation","perpetual","quotation","ridiculous","sanctuary",
    "terrifying","unanimous","variation","weathering","yesterday","zealously","abnormally","carefully","diligence","efficient",
    "flourished","gracefully","hindsight","incognito","juxtapose","kinesthetic","labyrinth","medallion","nefarious","obscurely",
    "plagiarism","qualified","rebellious","systematic","tenacious","unbearable","vigilance","wholesome","cacophony","deficiency"
  ],
  boss:[
    "incomprehensible","uncomfortable","revolutionary","acknowledgement","straightforward",
    "responsibility","circumstances","accomplishment","approximately","communication",
    "encouragement","extraordinary","qualification","unfortunately","administration",
    "comprehension","disappointment","establishment","opportunities","specification",
    "antidisestablishmentarianism","pneumonoultramicroscopicsilicovolcanoconiosis",
    "floccinaucinihilipilification","supercalifragilisticexpialidocious",
    "hippopotomonstrosesquippedaliophobia","pseudopseudohypoparathyroidism",
    "electroencephalographically","otorhinolaryngological","immunoelectrophoretically",
    "chargoggagoggmanchauggagoggchaubunagungamaugg",
    "dichlorodifluoromethane","psychophysicotherapeutics","thyroparathyroidectomized",
    "spectrophotofluorometrically","hepaticocholangiocholecystenterostomies"
  ]
};

// â”€â”€ AUDIO ENGINE (Web Audio API â€” no files needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioCtx = null;

function getAudioCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  // Resume if suspended (browser autoplay policy)
  if(audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// Short mechanical key click
function soundType(isCorrectLetter){
  try{
    const ctx = getAudioCtx();
    const buf = ctx.createBuffer(1, ctx.sampleRate * 0.04, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for(let i=0;i<data.length;i++){
      // White noise burst, decaying fast
      data[i] = (Math.random()*2-1) * Math.pow(1 - i/data.length, 8);
    }
    const src = ctx.createBufferSource();
    src.buffer = buf;
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(isCorrectLetter ? 0.18 : 0.28, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.04);
    // Slight pitch shift via playback rate
    src.playbackRate.value = isCorrectLetter ? 1.4 : 0.9;
    const filter = ctx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = isCorrectLetter ? 2800 : 1200;
    filter.Q.value = 1.5;
    src.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);
    src.start();
  }catch(e){}
}

// Bright ding â€” correct word
function soundDing(){
  try{
    const ctx = getAudioCtx();
    const now = ctx.currentTime;
    // Two harmonics for a bell-like tone
    [[880,0.5],[1760,0.25],[2640,0.12]].forEach(([freq,vol],i)=>{
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(vol, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.9 - i*0.1);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now);
      osc.stop(now + 0.9);
    });
  }catch(e){}
}

// Womp womp womp â€” three descending trombone blasts
function soundWomp(){
  try{
    const ctx = getAudioCtx();
    const now = ctx.currentTime;
    [0, 0.42, 0.84].forEach((delay, i) => {
      const startFreq = 320 - i * 60;
      const endFreq   = 140 - i * 40;
      const osc  = ctx.createOscillator();
      const gain = ctx.createGain();
      // Add slight vibrato via a second osc modulating frequency
      const vib  = ctx.createOscillator();
      const vibGain = ctx.createGain();
      vib.frequency.value = 6;
      vibGain.gain.value = 8;
      vib.connect(vibGain);
      vibGain.connect(osc.frequency);

      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(startFreq, now + delay);
      osc.frequency.exponentialRampToValueAtTime(endFreq, now + delay + 0.38);

      gain.gain.setValueAtTime(0, now + delay);
      gain.gain.linearRampToValueAtTime(0.45, now + delay + 0.04);
      gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.38);

      // Lowpass to make it bassy
      const filter = ctx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 900;

      osc.connect(filter);
      filter.connect(gain);
      gain.connect(ctx.destination);

      vib.start(now + delay);
      osc.start(now + delay);
      vib.stop(now + delay + 0.4);
      osc.stop(now + delay + 0.4);
    });
  }catch(e){}
}

// â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isFirstWordThisGame = true;
let speakTimeout = null;
let isAnnouncing = false;

const MALE_VOICE_NAMES = [
  'Google UK English Male','Microsoft David Desktop - English (United States)',
  'Microsoft David - English (United States)','Alex','Daniel','Fred','Aaron','Arthur','Albert'
];

function getVoices(){ return speechSynthesis.getVoices(); }
function pickMaleVoice(){
  const voices = getVoices();
  for(const name of MALE_VOICE_NAMES){
    const v = voices.find(v => v.name === name);
    if(v) return v;
  }
  return voices.find(v=>v.lang==='en-US') || voices.find(v=>v.lang.startsWith('en')) || voices[0] || null;
}
if(typeof speechSynthesis!=='undefined'){
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged=()=>speechSynthesis.getVoices();
}

function stopSpeech(){
  clearTimeout(speakTimeout);
  speechSynthesis.cancel();
  isAnnouncing=false;
  setAnnouncingUI(false);
}

function setAnnouncingUI(on){
  const el=document.getElementById('announcing');
  const inp=document.getElementById('game-input');
  const hint=document.getElementById('hint-text');
  el.classList.toggle('show',on);
  if(on){ inp.disabled=true; hint.classList.add('muted'); }
}

function speakThenReveal(w, onDone){
  stopSpeech();
  isAnnouncing=true;
  const phrase = isFirstWordThisGame ? `Spell the word. ${w}.` : `Alright, spell the word. ${w}.`;
  isFirstWordThisGame=false;
  setAnnouncingUI(true);
  speakTimeout=setTimeout(()=>{
    const utter=new SpeechSynthesisUtterance(phrase);
    utter.rate=0.82; utter.pitch=0.85; utter.volume=1;
    const v=pickMaleVoice(); if(v) utter.voice=v;
    utter.onend=()=>{ isAnnouncing=false; setAnnouncingUI(false); if(onDone) onDone(); };
    utter.onerror=()=>{ isAnnouncing=false; setAnnouncingUI(false); if(onDone) onDone(); };
    speechSynthesis.speak(utter);
  },60);
}

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROWS=[['Q','W','E','R','T','Y','U','I','O','P'],['A','S','D','F','G','H','J','K','L'],['Z','X','C','V','B','N','M']];
(function(){
  const kb=document.getElementById('keyboard');
  ROWS.forEach(row=>{const r=document.createElement('div');r.className='kb-row';row.forEach(k=>{const el=document.createElement('div');el.className='key';el.textContent=k;el.id='k'+k;r.appendChild(el);});kb.appendChild(r);});
})();
function flashKey(ch,ok){const el=document.getElementById('k'+ch.toUpperCase());if(!el)return;el.classList.add(ok?'ok':'err');setTimeout(()=>el.classList.remove('ok','err'),260);}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let score=0,streak=0,bestStreak=0,wordsTyped=0,hs=0;
let word='',used=[],usedBoss=[],maxT=10,tim=null,ticking=false,isBoss=false;
let totChars=0,keysTotal=0,keysCorrect=0,wStart=0,lastLen=0;
let wordWpmList=[],lastWordWpm=0,eliminatedWord='';
// Flag: set true the moment player completes a word, prevents timer from ending game
let wordSolved=false;

function getMultiplier(){return streak>=10?3:streak>=5?2:1;}
function pool(s){return s<5?W.easy:s<12?W.med:s<22?W.hard:W.exp;}

function timeFor(s,w,boss){
  if(boss) return Math.max(6, Math.ceil(w.length*0.65));
  const base=Math.max(10-Math.floor(s/4),4);
  const sp=Math.min(Math.floor(streak/3),4);
  return Math.max(base-sp+Math.ceil(w.length/5),3);
}

function pickWord(s,boss){
  if(boss){let w,a=0;do{w=W.boss[Math.floor(Math.random()*W.boss.length)];a++;}while(usedBoss.includes(w)&&a<10);return w;}
  const p=pool(s);let w,a=0;do{w=p[Math.floor(Math.random()*p.length)];a++;}while(used.includes(w)&&a<20);return w;
}

function $id(i){return document.getElementById(i);}
function show(id){$id(id).classList.remove('hidden');}
function hide(id){$id(id).classList.add('hidden');}
function showMenu(){
  stopSpeech();
  hide('screen-game');hide('screen-over');show('screen-menu');
  $id('menu-hs').textContent=hs>0?'ğŸ† Best: '+hs+' pts':'';
}

// â”€â”€ COUNTDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runCountdown(){
  stopSpeech();
  hide('screen-menu');hide('screen-over');hide('screen-game');
  $id('elim-banner').classList.remove('show');
  const cd=$id('countdown'),num=$id('cdown-num');
  cd.classList.remove('hidden');
  const steps=['3','2','1','GO!'];let i=0;
  (function step(){
    num.textContent=steps[i];num.style.animation='none';void num.offsetWidth;num.style.animation='cdown 1s ease forwards';i++;
    if(i<steps.length) setTimeout(step,900);
    else setTimeout(()=>{cd.classList.add('hidden');startGame();},700);
  })();
}

// â”€â”€ GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(){
  score=0;streak=0;bestStreak=0;wordsTyped=0;used=[];usedBoss=[];
  totChars=0;keysTotal=0;keysCorrect=0;wordWpmList=[];lastLen=0;
  ticking=false;isBoss=false;eliminatedWord='';lastWordWpm=0;
  isFirstWordThisGame=true;wordSolved=false;
  show('screen-game');updateHdr();updateCombo();updateFire();
  setNextWord(0,false);
}

function setNextWord(s,boss){
  isBoss=boss; wordSolved=false;
  word=pickWord(s,boss);
  if(boss) usedBoss.push(word); else used.push(word);

  const wl=$id('word-letters'),inp=$id('game-input');
  wl.classList.add('hidden-word');
  wl.classList.remove('reveal','boss-word');
  inp.value='';inp.disabled=true;inp.style.opacity='1';
  lastLen=0;
  $id('timer-wrap').classList.remove('pulse');
  $id('live-wpm').textContent='';
  $id('boss-label').style.opacity=boss?'1':'0';
  renderWordBlank();
  updateBar(1,1);

  speakThenReveal(word, ()=>{ revealWordAndStart(s,boss); });
}

function renderWordBlank(){
  $id('word-letters').innerHTML=word.split('').map(()=>`<span style="color:var(--dim)">Â·</span>`).join('');
}

function revealWordAndStart(s,boss){
  const wl=$id('word-letters'),inp=$id('game-input'),hint=$id('hint-text');
  renderWord();
  wl.classList.remove('hidden-word');
  wl.classList.add('reveal');
  if(boss) wl.classList.add('boss-word');
  inp.disabled=false;
  hint.classList.remove('muted');
  const t=timeFor(s,word,boss);maxT=t;
  startTimer(t);
  wStart=Date.now();
  setTimeout(()=>inp.focus(),30);
}

function renderWord(){
  const v=$id('game-input').value;
  const boss=isBoss;
  $id('word-letters').innerHTML=word.split('').map((ch,i)=>{
    const tp=v[i];
    const c=!tp?(boss?'var(--danger)':'var(--text)'):tp.toLowerCase()===ch.toLowerCase()?'var(--correct)':'var(--danger)';
    return `<span style="color:${c};transition:color .08s">${ch.toUpperCase()}</span>`;
  }).join('');
  if(v.length>0){
    const elapsed=(Date.now()-wStart)/60000;
    if(elapsed>0){const live=Math.round((v.length/5)/elapsed);$id('live-wpm').textContent=live+' WPM  Â·  typing now';}
  } else {
    $id('live-wpm').textContent='';
  }
}

function startTimer(t){
  clearInterval(tim);let left=t;updateBar(left,t);
  tim=setInterval(()=>{
    left--;updateBar(left,maxT);
    if(left<=3&&left>0) $id('timer-wrap').classList.add('pulse');
    else if(left>3) $id('timer-wrap').classList.remove('pulse');
    if(left<=0){
      clearInterval(tim);
      // Only end the game if the player hasn't already solved the word
      if(!wordSolved){ soundWomp(); eliminatedWord=''; endGame('time'); }
    }
  },1000);
}

function updateBar(l,m){
  const p=l/m,bar=$id('timer-bar');
  bar.style.width=(p*100)+'%';
  bar.style.background=p>.5?'var(--correct)':p>.25?'var(--warn)':'var(--danger)';
}

function updateHdr(){
  $id('hdr-score').textContent=score;
  const s=$id('hdr-streak');s.textContent=streak;
  s.style.color=streak>=5?'var(--accent)':streak>=3?'var(--correct)':'var(--text)';
  $id('hdr-wpm-strip').textContent=lastWordWpm>0?lastWordWpm+' WPM':'â€” WPM';
}
function updateFire(){
  const f=streak>=10?'ğŸ”¥ğŸ”¥ğŸ”¥':streak>=7?'ğŸ”¥ğŸ”¥':streak>=5?'ğŸ”¥':'';
  $id('fire-icons').textContent=f?' '+f:'';
}
function updateCombo(){
  const m=getMultiplier(),b=$id('combo-badge');
  if(m>1){b.className='combo-badge show x'+m;b.textContent=m+'Ã— COMBO';}
  else{b.className='combo-badge';}
}
function flashWpm(wpm){
  const el=$id('wpm-flash');
  el.textContent=wpm+' WPM';el.classList.remove('pop');void el.offsetWidth;el.classList.add('pop');
}

// â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onInput(){
  if(ticking||isAnnouncing) return;
  const el=$id('game-input'),v=el.value;
  if(v.length>lastLen){
    const ch=v[v.length-1];
    const ex=word[v.length-1];
    const isCorrect=ch&&ex&&ch.toLowerCase()===ex.toLowerCase();
    flashKey(ch,isCorrect);
    soundType(isCorrect);          // â† typing sound on every keystroke
    keysTotal+=(v.length-lastLen);
  }
  lastLen=v.length;
  renderWord();
  if(v.toLowerCase()===word.toLowerCase()) submitCorrect();
}

function onKey(e){
  if(ticking||isAnnouncing) return;
  if(e.key==='Enter'){
    const v=$id('game-input').value.trim();
    if(!v) return;
    if(v.toLowerCase()===word.toLowerCase()){
      submitCorrect();
    } else {
      eliminatedWord=v;
      clearInterval(tim);
      $id('timer-wrap').classList.remove('pulse');
      soundWomp();                 // â† womp on wrong manual submit too
      endGame('wrong');
    }
  }
}

function submitCorrect(){
  wordSolved=true;                 // â† guard against race with timer
  clearInterval(tim);
  $id('timer-wrap').classList.remove('pulse');
  stopSpeech();
  soundDing();                     // â† ding!

  const ms=Date.now()-wStart;
  const wordWpm=Math.round((word.length/5)/(ms/60000));
  lastWordWpm=wordWpm;wordWpmList.push(wordWpm);

  keysCorrect+=word.length;totChars+=word.length;
  const mult=getMultiplier();
  score+=mult;streak++;wordsTyped++;
  if(streak>bestStreak) bestStreak=streak;
  if(score>hs) hs=score;

  flashWpm(wordWpm);showScorePop(mult);
  updateHdr();updateCombo();updateFire();doBurst();

  ticking=true;
  const el=$id('game-input');
  el.disabled=true;el.style.opacity='0';
  $id('word-letters').style.visibility='hidden';
  const tk=$id('tick-el');tk.style.display='block';tk.style.animation='none';void tk.offsetWidth;tk.style.animation='pop .38s ease';

  setTimeout(()=>{
    tk.style.display='none';$id('word-letters').style.visibility='visible';
    ticking=false;
    const nextBoss=wordsTyped>0&&wordsTyped%10===0;
    setNextWord(score,nextBoss);
  },480);
}

function showScorePop(mult){
  if(mult<=1) return;
  const r=$id('word-area').getBoundingClientRect();
  const el=document.createElement('div');el.className='score-pop';
  el.style.cssText=`left:${r.right+6}px;top:${r.top+10}px;color:${mult>=3?'var(--danger)':'var(--warn)'}`;
  el.textContent='+'+mult;document.body.appendChild(el);setTimeout(()=>el.remove(),850);
}

function doBurst(){
  const r=$id('word-area').getBoundingClientRect();
  const cx=r.left+r.width/2,cy=r.top+r.height/2;
  const cols=['var(--accent)','var(--correct)','var(--accent2)'];
  for(let i=0;i<16;i++){
    const p=document.createElement('div');p.className='pt';
    const a=(i/16)*360,d=45+Math.random()*50;
    const dx=Math.cos(a*Math.PI/180)*d,dy=Math.sin(a*Math.PI/180)*d;
    p.style.cssText=`left:${cx}px;top:${cy}px;background:${cols[i%3]};--dx:${dx}px;--dy:${dy}px`;
    document.body.appendChild(p);setTimeout(()=>p.remove(),660);
  }
}

// â”€â”€ GAME OVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function endGame(reason){
  stopSpeech();
  if(reason==='wrong'){
    $id('elim-msg').textContent='âŒ ELIMINATED';
    $id('elim-word').textContent='you typed: "'+eliminatedWord+'"';
    $id('elim-correct').textContent='correct: '+word.toUpperCase();
  } else {
    $id('elim-msg').textContent="â± TIME'S UP";
    $id('elim-word').textContent='the word was: '+word.toUpperCase();
    $id('elim-correct').textContent='';
  }
  $id('elim-banner').classList.add('show');
  setTimeout(()=>{$id('elim-banner').classList.remove('show');showOver();},1800);
}

function showOver(){
  hide('screen-game');show('screen-over');
  $id('over-score').textContent=score;
  $id('over-word-label').textContent=wordsTyped+' word'+(wordsTyped!==1?'s':'')+' typed';
  $id('over-hs').textContent=score>0&&score>=hs?'ğŸ† New High Score!':hs>0?'Best: '+hs+' pts':'';
  const best=wordWpmList.length?Math.max(...wordWpmList):0;
  const avg=wordWpmList.length?Math.round(wordWpmList.reduce((a,b)=>a+b,0)/wordWpmList.length):0;
  $id('st-best-wpm').textContent=best||'â€”';
  $id('st-avg-wpm').textContent=avg||'â€”';
  $id('st-acc').textContent=keysTotal>0?Math.round(keysCorrect/keysTotal*100)+'%':'â€”';
  $id('st-streak').textContent=bestStreak;
}
</script>
</body>
</html>
